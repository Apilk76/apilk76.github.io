---
id: 340
layout: post
title: Your Fast Catalog
categories: [Google, Libraries, Web Design]
---
<p><a href="http://catalog.cantonpl.org/">Canton Public Library's Catalog</a> uses a large library application called <a href="http://www.iii.com/products/millennium_ils.shtml">Millennium ILS from Innovative Interfaces, Inc</a>. Recently, I undertook to spruce up the images, styles, and JavaScript for our catalog, and in doing so realized substantial speed increases catalog-wide.</p>
<p><strong>Note</strong>: The speed enhancements below are mostly about optimizing files and client-side stuff. You can also speed up your catalog on the server side with hardware and database optimization, though doing so is likely to require assistance from Innovative.</p>
<h3>Why</h3>
<p>Faster-loading pages make users happier. Some speed-enhancing techniques also increase server performance and decrease the amount of bandwidth used. Page speed also factors into search engine rankings, though that is less of a concern for our catalog than our website.</p>
<h3>How</h3>
<p>Most of the improvements came from <a href="http://code.google.com/speed/page-speed/index.html">Google Page Speed</a> recommendations.</p>
<h4>Sprites</h4>
<p><strong>Fact I found interesting</strong>: Before I applied the catalog changes, the directory contained 682 files. It now has 49. Having fewer files doesn't inherently speed up the app, but it does speak to the nature of the changes.</p>
<p>There are two types of images in a Millennium "example set": icons (or whole buttons as images) and media type indicators. A typical setup, until recently, had 145 or so button images. The most recent example set available from Innovative has 45 icons and a couple support images for making buttons. These images are coupled with some crufty markup to make the buttons work. The latest set also ships with 39 media indicators (in fairness, we'd use maybe 13 of those for our library).</p>
<p>CPL now has <a href="http://catalog.cantonpl.org/screens/ico-sp.png">one image for all the icons</a> and <a href="http://catalog.cantonpl.org/screens/media-sp.png">one image for all the media indicators</a>. In total, the catalog screens have 8 images: one is required but never used, <a href="http://www.perlmonks.org/?node_id=7974">another never seen</a>, and two others used infrequently. Yes, we grab book jackets from an external service, but that's the extent of the catalog graphics.</p>
<p>An individual example icon weighs in between 600 bytes and 1.3K. Our icon sprite is 5.44K. It can be loaded once and <a href="http://code.google.com/speed/page-speed/docs/caching.html#LeverageBrowserCaching">cached on the user's machine</a>. For pages with many buttons, this results in far fewer HTTP requests and a smaller total payload. The same goes for media indicators.</p>
<p>How do we pull this off? We use two spriting techniques: <a href="http://css-tricks.com/css-sprites/">'traditional' sprites</a> and <a href="http://css-tricks.com/pseudo-spriting/">pseudo sprites</a>. The styles to makes these work can be found in the <a href="http://catalog.cantonpl.org/screens/styles.css">catalog stylesheet</a>. What's novel, and how you can pull this off in Millennium, is in carefully crafting what're called 'wwwoptions':</p>
<pre>
# pseudo sprite example
ICON_BUT_REQUEST=&lt;span class="but icon request"&gt;Request&lt;/span&gt;

# traditional sprite example
IMAGE_MATTYPE3=/screens/spacer.gif" class="media-icon bookmp3
</pre>
<p>As you can see, in both cases activating sprites involves appending classes to a particular HTML element. In the case of the pseudo sprites, there's a class that makes anything look like a button, one that pads the left-hand side and loads the icon sprite image into the space, and one ['request' above] that stipulates where in the sprite image the request icon appears. In the traditional sprite, the "IMAGE_MATTYPE3" option <em>must</em> be an image. Since there's no getting around that, I used a spacer gif. It's 43 bytes — the smallest practical image for the web. I then <a href="http://google-gruyere.appspot.com/part2#2__stored_xss_via_html_attribute">circumvented the wwwoption to add the classes to the image</a>. Those classes set the background size and position the sprite image.</p>
<p>Be advised that pseudo sprites only work in standards-compliant browsers and IE8+. If a substantial number of your users are on IE7-, you may want to wait. Users with non-supporting browsers can still see the button style we use, but the icons won't appear. Sites that work for everyone but look better for modern browsers are considered <a href="http://www.alistapart.com/articles/understandingprogressiveenhancement">progressively-enhanced</a>; that's what you can consider these buttons.</p>
<h4>Distrusting Bowker</h4>
<p>We use <a href="http://www.bowker.com/en-US/products/syndetics/plus/index.html">Syndetics Plus</a>, <a href="http://www.librarything.com/forlibraries">Librarything for Libraries</a>, and <a href="http://code.google.com/apis/books/docs/viewer/developers_guide.html">Google Books previews</a> on our bibliographic record pages. That's a lot of stuff to load. As part of an overall improvement in JavaScript performance, we changed the way we <a href="http://api.jquery.com/jQuery.getScript/">pull in those resources</a>.</p>
<p>Syndetics Plus, by default, loads onto a page something like this</p>
<ul>
<li>Page calls widget.js directly, via a script tag</li>
<li>widget.js loads jQuery from Google's CDN</li>
<li>After jQuery is loaded, widget.js loads widget_connector.js</li>
<li>widget_connector.js gets ready, finds ISBNs on the page, and requests an ISBN-specific widget_response.js</li>
<li>widget_response.js writes to the page and asks widget_connector.js to do stuff</li>
</ul>
<p>This is a mess. It's a long chain of <a href="http://code.google.com/speed/page-speed/docs/rtt.html#ParallelizeDownloads">serialized resources</a> that aren't well-cached by the browser, aren't served <a href="http://marijnhaverbeke.nl/uglifyjs">minified</a> and/or <a href="http://httpd.apache.org/docs/2.0/mod/mod_deflate.html">gzipped</a>, can't be <a href="http://en.wikipedia.org/wiki/Transport_Layer_Security">served over SSL</a>, and that <a href="http://code.google.com/speed/page-speed/docs/payload.html#DeferLoadingJS">block full page rendering</a> until they're complete (whether or not there's a result). Total payload for this process is 49K.</p>
<p>Librarything for Libraries is even worse (<a href="http://hawidu.com/2010/12/11/librarything-issues/">here I go again</a>). It goes:</p>
<ul>
<li>Page calls widget.php (served as javascript) directly, via a script tag</li>
<li>widget.php loads connector.php</li>
<li>connector.php pulls in connector_LB.css</li>
<li>connector.php gets ready, finds ISBNs on the page, and requests an ISBN-specific widget_response.php</li>
<li>widget_response.php writes to the page and asks connector.php to do stuff</li>
</ul>
<p>What makes this process so awful is connector.php. It's over 150K all by itself, and it includes the <a href="http://sizzlejs.com/">sizzle selector library</a> and a bunch of <a href="http://robertnyman.com/2005/11/07/the-ultimate-getelementsbyclassname/">other</a> <a href="http://blog.stchur.com/2007/04/06/serializing-objects-in-javascript/">utilities</a>. Which makes one wonder — why not just use jQuery? Moreover, why does a file that loads a comprehensive selector engine need to define getElementsByClassName()? connector.php's JavaScript is a Frankenstein's monster of code that pollutes the global namespace. I'm afraid that <a href="https://twitter.com/librarythingtim/statuses/167130139891728384">some people might be having nightmares over it</a>. This file also includes all functionality for all different ILSes (not just Millennium, the one we're using) and all LTfL features (a small fraction of which we're using). This massive file is unminified and uncompressed and is part of a call chain that doesn't support HTTP keep-alive. Minifying the file wouldn't solve all the problems, but it would be less than half the size (mostly because their variable names are massive). Ditto on gzip compression, which could make it less than a quarter of its heft over the wire (without minification!).</p>
<p>We <a href="http://code.google.com/apis/libraries/">pull in jQuery from Google</a> (the old-fashioned way, so it client-side caches for just about ever) and use it for almost all the <a href="http://catalog.cantonpl.org/screens/canton.js">(CPL-made) JavaScript</a> on the page. The code for us to replace Syndetics Plus's payload (25K without jQuery) is 150 bytes before compression. The nearly 200K for LTfL? Less than 1K, and I could probably optimize further.</p>
<p>CPL-specific code pulls the primary ISBN from bib record pages, validates it, then makes sure the page is served as regular HTTP. All of this occurs after the page has already loaded. If the conditions are met, we then feed the ISBN to the widget_response files from the two services, getting back just the results specific to the bib record. The widget_response files handle writing to the page all by themselves, so the service-specific code just adds things those scripts expect to find and handles certain on-page actions. Since we do this all asynchronously, the page loads (and <em>feels</em> like it loads) as quickly as Millennium allows.</p>
<p>Being careful with the three widget services provided the biggest overall improvement to payload size and page rendering speed. Google Page Speed eliminated the warnings about redirects, uncompressed resources, request serialization, unminified javascript, and undeferred scripts.</p>
<p>What's funny about the terribleness coming from Bowker's servers is that a big part of improving the situation is both easy <em>and</em> a big sack of win. Users would get faster pages and Bowker'd save on bandwidth and hardware specs. Some quick apache config of mod_expires and mod_deflate is all that's required to pay dividends. A deployment scheme involving minification and/or a refactor of the connector scripts would be more time-consuming, but could make the widgets substantially faster. Serving out static scripts without query strings would be a huge help, for instance.</p>
<h4>More JavaScript Optimization</h4>
<p>I was more diligent about jQuery best practices like using <a href="http://net.tutsplus.com/tutorials/javascript-ajax/quick-tip-think-right-to-left-with-jquery/">fast selectors</a>, <a href="http://www.artzstudio.com/2009/04/jquery-performance-rules/#cache-jquery-objects">caching selected objects</a>, and <a href="http://thinkvitamin.com/code/john-resig-on-advanced-javascript-to-improve-your-web-app/">delegating events to their appropriate containers</a>.</p>
<p>Millennium has its own JavaScript library. It's ordinarily served out as 3 files, but we weren't having any of that. Our Millennium setup <a title="This is an old presentation" href="https://docs.google.com/viewer?url=http://www.rodmanlibrary.com/iug/egl2008/hackthepac.pdf">prevents the default files from loading</a>, and instead serves <a href="http://catalog.cantonpl.org/screens/iii.js">a single file with all three components minified</a>. iii.js is just under 20K before compression, and 5.2 over the wire. That's 2 fewer HTTP requests and 4.4K less payload on every page.</p>
<h4>Image Optimization</h4>
<p>I ran all the catalog images through <a href="http://pnggauntlet.com/">PNGGauntlet</a>, which uses <a href="http://advsys.net/ken/utils.htm">PNGOUT</a> to reduce file size — sometimes by 25% or more. For high-use files, I also weighed the quality reduction of making them 8-bit PNGs; the sprites, for instance, get served out as 8-bit files, making them substantially smaller.</p>
<h4>Web Server</h4>
<p>I also rolled out <a href="http://www.cantonpl.org/sites/all/themes/zen/cpl/sprites/site-sp-v011712r1.png">a sprite for the site</a>'s layout and theme, optimized the chat widget, and <a href="http://lowfatcats.com/blog/1-tutorial/18-how-to-optimize-javascript-css-linux-using-yui-compressor.html">combined and minified CSS files</a> for use by the catalog. Our web server, in contrast to the catalog, is pretty aggressive about caching. Files are served with far-future expires headers. APC for PHP caches the opcode to minimize file reads; this results in faster execution speed across the board, but not necessarily faster serving to the end user. We have <a href="http://drupal.org/">drupal</a> caching set up, which benefits from MySQL query caching. Apache gets some love from the OS's buffer cache. Altogether, the website is a layer of caches.</p>
<h3>What's Next</h3>
<p>I'd like to reduce the payload of every page on our site by rolling out a new theme. There's a lot of extraneous markup and styling that can get cut out pretty easily. Other possibilities:</p>
<ul>
<li>Optimize images as they're uploaded</li>
<li>Minify CSS and JavaScript on <a href="http://liquidninja.com/deploying-with-git/">theme deployment</a></li>
<li>Defer jQuery and other <a href="https://developer.mozilla.org/En/HTML/Element/Script#Attributes">scripts</a> on page loads</li>
<li>Put stuff into a <a href="http://www.html5rocks.com/en/tutorials/appcache/beginner/">cache manifest</a></li>
<li>Investigate <a href="http://code.google.com/speed/page-speed/docs/module.html">mod_pagespeed</a> to do some of this stuff automatically</li>
</ul>
<p>For the catalog, a few squeaks of extra speed could come from moving static files to our web server (which has longer cache lifetimes), combining the [minified] catalog CSS into the site CSS, and working with Syndetics to get book jackets from URLs without query parameters.</p>
<h3>tl;dr</h3>
<p><a href="http://code.google.com/speed/page-speed/index.html">Google Page Speed</a>.</p>